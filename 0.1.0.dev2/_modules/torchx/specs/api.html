


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>torchx.specs.api &mdash; PyTorch/TorchX master documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!-- <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" /> -->
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0-beta/dist/katex.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/torchx.css" type="text/css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/katex-math.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery-binder.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery-dataframe.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery-rendered-html.css" type="text/css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0-beta/dist/katex.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/torchx.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
  <!-- Google Analytics -->
  
  <!-- End Google Analytics -->
  

  
  <script src="../../../_static/js/modernizr.min.js"></script>

  <!-- Preload the theme fonts -->

<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-book.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/IBMPlexMono/IBMPlexMono-Medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-medium-italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/IBMPlexMono/IBMPlexMono-SemiBold.woff2" as="font" type="font/woff2" crossorigin="anonymous">

<!-- Preload the katex fonts -->

<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Math-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size1-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size4-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size2-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size3-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Caligraphic-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css" integrity="sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu" crossorigin="anonymous">
</head>

<div class="container-fluid header-holder tutorials-header" id="header-holder">
  <div class="container">
    <div class="header-container">
      <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>

      <div class="main-menu">
        <ul>
          <li>
            <a href="https://pytorch.org/get-started">Get Started</a>
          </li>

          <li>
            <a href="https://pytorch.org/ecosystem">Ecosystem</a>
          </li>

          <li>
            <a href="https://pytorch.org/mobile">Mobile</a>
          </li>

          <li>
            <a href="https://pytorch.org/blog/">Blog</a>
          </li>

          <li>
            <a href="https://pytorch.org/tutorials">Tutorials</a>
          </li>

          <li>
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="resource-option with-down-orange-arrow">
                Docs
              </a>
              <div class="resources-dropdown-menu">
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/docs/stable/index.html">
                  <span class="dropdown-title">PyTorch</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/audio/stable/index.html">
                  <span class="dropdown-title">torchaudio</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/text/stable/index.html">
                  <span class="dropdown-title">torchtext</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/vision/stable/index.html">
                  <span class="dropdown-title">torchvision</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/elastic/">
                  <span class="dropdown-title">TorchElastic</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/serve/">
                  <span class="dropdown-title">TorchServe</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/xla">
                  <span class="dropdown-title">PyTorch on XLA Devices</span>
                  <p></p>
                </a>
            </div>
          </li>

          <li>
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="resource-option with-down-arrow">
                Resources
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://pytorch.org/features">
                  <span class="dropdown-title">About</span>
                  <p>Learn about PyTorchâ€™s features and capabilities</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/#community-module">
                  <span class="dropdown-title">Community</span>
                  <p>Join the PyTorch developer community to contribute, learn, and get your questions answered.</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/resources">
                  <span class="dropdown-title">Developer Resources</span>
                  <p>Find resources and get questions answered</p>
                </a>
                <a class="nav-dropdown-item" href="https://discuss.pytorch.org/" target="_blank">
                  <span class="dropdown-title">Forums</span>
                  <p>A place to discuss PyTorch code, issues, install, research</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/hub">
                  <span class="dropdown-title">Models (Beta)</span>
                  <p>Discover, publish, and reuse pre-trained models</p>
                </a>
              </div>
            </div>
          </li>

          <li>
            <a href="https://github.com/pytorch/pytorch">GitHub</a>
          </li>
        </ul>
      </div>

      <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu"></a>
    </div>
  </div>
</div>

<body class="pytorch-body">

   

    

    <div class="table-of-contents-link-wrapper">
      <span>Table of Contents</span>
      <a href="#" class="toggle-table-of-contents" data-behavior="toggle-table-of-contents"></a>
    </div>

    <nav data-toggle="wy-nav-shift" class="pytorch-left-menu" id="pytorch-left-menu">
      <div class="pytorch-side-scroll">
        <div class="pytorch-menu pytorch-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          <div class="pytorch-left-menu-search">
            
    <div class="version">
      <a href='/torchx/versions.html'>v0.1.0.dev2 &#x25BC</a>
    </div>
    


  


<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search Docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          </div>

          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Usage</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../basics.html">Basics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cli.html">CLI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../configure.html">Configuring</a></li>
</ul>
<p class="caption"><span class="caption-text">Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../examples_apps/index.html">Application Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples_pipelines/index.html">Pipelines Examples</a></li>
</ul>
<p class="caption"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../specs.html">torchx.specs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../components.html">torchx.components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../runner.html">torchx.runner</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../schedulers.html">torchx.schedulers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pipelines.html">torchx.pipelines</a></li>
</ul>
<p class="caption"><span class="caption-text">Components</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../components/base.html">Base</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../components/distributed.html">Distributed</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../components/serve.html">Serve</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../components/hpo.html">HPO</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../components/utils.html">Utils</a></li>
</ul>
<p class="caption"><span class="caption-text">Schedulers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../schedulers/local.html">Localhost</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../schedulers/kubernetes.html">Kubernetes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../schedulers/slurm.html">Slurm</a></li>
</ul>
<p class="caption"><span class="caption-text">Pipeline Adapters</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../pipelines/kfp.html">Kubeflow Pipelines</a></li>
</ul>
<p class="caption"><span class="caption-text">Beta Features</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../beta.html">Coming Soon</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <div class="pytorch-container">
      <div class="pytorch-page-level-bar" id="pytorch-page-level-bar">
        <div class="pytorch-breadcrumbs-wrapper">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="pytorch-breadcrumbs">
    
      <li>
        <a href="../../../index.html">
          
            Docs
          
        </a> &gt;
      </li>

        
          <li><a href="../../index.html">Module code</a> &gt;</li>
        
          <li><a href="../specs.html">torchx.specs</a> &gt;</li>
        
      <li>torchx.specs.api</li>
    
    
      <li class="pytorch-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
</div>
        </div>

        <div class="pytorch-shortcuts-wrapper" id="pytorch-shortcuts-wrapper">
          Shortcuts
        </div>
      </div>

      <section data-toggle="wy-nav-shift" id="pytorch-content-wrap" class="pytorch-content-wrap">
        <div class="pytorch-content-left">

        
  

  <!-- copied from pytorch_sphinx_theme -->
  
  <div class="rst-content">
  
    <div role="main" class="main-content" itemscope="itemscope" itemtype="http://schema.org/Article">
     <article itemprop="articleBody" id="pytorch-article" class="pytorch-article">
      
  <h1>Source code for torchx.specs.api</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># Copyright (c) Facebook, Inc. and its affiliates.</span>
<span class="c1"># All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># This source code is licensed under the BSD-style license found in the</span>
<span class="c1"># LICENSE file in the root directory of this source tree.</span>

<span class="c1"># TODO(aivanou): Update documentation</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">asdict</span><span class="p">,</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span> <span class="nn">string</span> <span class="kn">import</span> <span class="n">Template</span>
<span class="kn">from</span> <span class="nn">types</span> <span class="kn">import</span> <span class="n">ModuleType</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Any</span><span class="p">,</span>
    <span class="n">Callable</span><span class="p">,</span>
    <span class="n">Dict</span><span class="p">,</span>
    <span class="n">Generic</span><span class="p">,</span>
    <span class="n">List</span><span class="p">,</span>
    <span class="n">Mapping</span><span class="p">,</span>
    <span class="n">Optional</span><span class="p">,</span>
    <span class="n">Tuple</span><span class="p">,</span>
    <span class="n">Type</span><span class="p">,</span>
    <span class="n">TypeVar</span><span class="p">,</span>
    <span class="n">Union</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">pyre_extensions</span> <span class="kn">import</span> <span class="n">none_throws</span>
<span class="kn">from</span> <span class="nn">torchx.specs.file_linter</span> <span class="kn">import</span> <span class="n">parse_fn_docstring</span><span class="p">,</span> <span class="n">validate</span>
<span class="kn">from</span> <span class="nn">torchx.util.io</span> <span class="kn">import</span> <span class="n">read_conf_file</span>
<span class="kn">from</span> <span class="nn">torchx.util.types</span> <span class="kn">import</span> <span class="n">decode_from_string</span><span class="p">,</span> <span class="n">is_primitive</span><span class="p">,</span> <span class="n">decode_optional</span>


<span class="n">SchedulerBackend</span> <span class="o">=</span> <span class="nb">str</span>

<span class="c1"># ========================================</span>
<span class="c1"># ==== Distributed AppDef API =======</span>
<span class="c1"># ========================================</span>
<div class="viewcode-block" id="Resource"><a class="viewcode-back" href="../../../specs.html#torchx.specs.Resource">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Resource</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents resource requirements for a ``Role``.</span>

<span class="sd">    Args:</span>
<span class="sd">        cpu: number of cpu cores (note: not hyper threads)</span>
<span class="sd">        gpu: number of gpus</span>
<span class="sd">        memMB: MB of ram</span>
<span class="sd">        capabilities: additional hardware specs (interpreted by scheduler)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">cpu</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">gpu</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">memMB</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">capabilities</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>

<div class="viewcode-block" id="Resource.copy"><a class="viewcode-back" href="../../../specs.html#torchx.specs.Resource.copy">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="n">original</span><span class="p">:</span> <span class="s2">&quot;Resource&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">capabilities</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Resource&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Copies a resource and applies new capabilities. If the same capabilities</span>
<span class="sd">        are present in the original resource and as parameter, the one from parameter</span>
<span class="sd">        will be used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">res_capabilities</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">original</span><span class="o">.</span><span class="n">capabilities</span><span class="p">)</span>
        <span class="n">res_capabilities</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">capabilities</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Resource</span><span class="p">(</span>
            <span class="n">cpu</span><span class="o">=</span><span class="n">original</span><span class="o">.</span><span class="n">cpu</span><span class="p">,</span>
            <span class="n">gpu</span><span class="o">=</span><span class="n">original</span><span class="o">.</span><span class="n">gpu</span><span class="p">,</span>
            <span class="n">memMB</span><span class="o">=</span><span class="n">original</span><span class="o">.</span><span class="n">memMB</span><span class="p">,</span>
            <span class="n">capabilities</span><span class="o">=</span><span class="n">res_capabilities</span><span class="p">,</span>
        <span class="p">)</span></div></div>


<span class="c1"># sentinel value used for cases when resource does not matter (e.g. ignored)</span>
<span class="n">NULL_RESOURCE</span><span class="p">:</span> <span class="n">Resource</span> <span class="o">=</span> <span class="n">Resource</span><span class="p">(</span><span class="n">cpu</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">gpu</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">memMB</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># used as &quot;*&quot; scheduler backend</span>
<span class="n">ALL</span><span class="p">:</span> <span class="n">SchedulerBackend</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span>

<span class="c1"># sentinel value used to represent missing string attributes, such as image or entrypoint</span>
<span class="n">MISSING</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&lt;MISSING&gt;&quot;</span>

<span class="c1"># sentinel value used to represent &quot;unset&quot; optional string attributes</span>
<span class="n">NONE</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&lt;NONE&gt;&quot;</span>


<div class="viewcode-block" id="macros"><a class="viewcode-back" href="../../../specs.html#torchx.specs.macros">[docs]</a><span class="k">class</span> <span class="nc">macros</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Defines macros that can be used with ``Role.entrypoint`` and ``Role.args``.</span>
<span class="sd">    The macros will be substituted at runtime to their actual values.</span>

<span class="sd">    Available macros:</span>

<span class="sd">    1. ``img_root`` - root directory of the pulled container.image</span>
<span class="sd">    2. ``base_img_root`` - root directory of the pulled role.base_image</span>
<span class="sd">                           (resolves to &quot;&lt;NONE&gt;&quot; if no base_image set)</span>
<span class="sd">    3. ``app_id`` - application id as assigned by the scheduler</span>
<span class="sd">    4. ``replica_id`` - unique id for each instance of a replica of a Role,</span>
<span class="sd">                        for instance a role with 3 replicas could have the 0, 1, 2</span>
<span class="sd">                        as replica ids. Note that when the container fails and is</span>
<span class="sd">                        replaced, the new container will have the same ``replica_id``</span>
<span class="sd">                        as the one it is replacing. For instance if node 1 failed and</span>
<span class="sd">                        was replaced by the scheduler the replacing node will also</span>
<span class="sd">                        have ``replica_id=1``.</span>

<span class="sd">    Example:</span>

<span class="sd">    ::</span>

<span class="sd">     # runs: hello_world.py --app_id ${app_id}</span>
<span class="sd">     trainer = Role(name=&quot;trainer&quot;).runs(&quot;hello_world.py&quot;, &quot;--app_id&quot;, macros.app_id)</span>
<span class="sd">     app = AppDef(&quot;train_app&quot;).of(trainer)</span>
<span class="sd">     app_handle = session.run(app, scheduler=&quot;local&quot;, cfg=RunConfig())</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">img_root</span> <span class="o">=</span> <span class="s2">&quot;$</span><span class="si">{img_root}</span><span class="s2">&quot;</span>
    <span class="n">base_img_root</span> <span class="o">=</span> <span class="s2">&quot;$</span><span class="si">{base_img_root}</span><span class="s2">&quot;</span>
    <span class="n">app_id</span> <span class="o">=</span> <span class="s2">&quot;$</span><span class="si">{app_id}</span><span class="s2">&quot;</span>
    <span class="n">replica_id</span> <span class="o">=</span> <span class="s2">&quot;$</span><span class="si">{replica_id}</span><span class="s2">&quot;</span>

<div class="viewcode-block" id="macros.Values"><a class="viewcode-back" href="../../../specs.html#torchx.specs.macros.Values">[docs]</a>    <span class="nd">@dataclass</span>
    <span class="k">class</span> <span class="nc">Values</span><span class="p">:</span>
        <span class="n">img_root</span><span class="p">:</span> <span class="nb">str</span>
        <span class="n">app_id</span><span class="p">:</span> <span class="nb">str</span>
        <span class="n">replica_id</span><span class="p">:</span> <span class="nb">str</span>
        <span class="n">base_img_root</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">NONE</span>

<div class="viewcode-block" id="macros.Values.apply"><a class="viewcode-back" href="../../../specs.html#torchx.specs.macros.Values.apply">[docs]</a>        <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">role</span><span class="p">:</span> <span class="s2">&quot;Role&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Role&quot;</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            apply applies the values to a copy the specified role and returns it.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">role</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">role</span><span class="p">)</span>
            <span class="n">role</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">role</span><span class="o">.</span><span class="n">args</span><span class="p">]</span>
            <span class="n">role</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">role</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="k">return</span> <span class="n">role</span></div>

<div class="viewcode-block" id="macros.Values.substitute"><a class="viewcode-back" href="../../../specs.html#torchx.specs.macros.Values.substitute">[docs]</a>        <span class="k">def</span> <span class="nf">substitute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            substitute applies the values to the template arg.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="n">Template</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span><span class="o">.</span><span class="n">safe_substitute</span><span class="p">(</span><span class="o">**</span><span class="n">asdict</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span></div></div></div>


<div class="viewcode-block" id="RetryPolicy"><a class="viewcode-back" href="../../../specs.html#torchx.specs.RetryPolicy">[docs]</a><span class="k">class</span> <span class="nc">RetryPolicy</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Defines the retry policy for the ``Roles`` in the ``AppDef``.</span>
<span class="sd">    The policy defines the behavior when the role replica encounters a failure:</span>

<span class="sd">    1. unsuccessful (non zero) exit code</span>
<span class="sd">    2. hardware/host crashes</span>
<span class="sd">    3. preemption</span>
<span class="sd">    4. eviction</span>

<span class="sd">    .. note:: Not all retry policies are supported by all schedulers.</span>
<span class="sd">              However all schedulers must support ``RetryPolicy.APPLICATION``.</span>
<span class="sd">              Please refer to the scheduler&#39;s documentation for more information</span>
<span class="sd">              on the retry policies they support and behavior caveats (if any).</span>

<span class="sd">    1. REPLICA: Replaces the replica instance. Surviving replicas are untouched.</span>
<span class="sd">                Use with ``torch_dist_role`` to have torch coordinate restarts</span>
<span class="sd">                and membership changes. Otherwise, it is up to the application to</span>
<span class="sd">                deal with failed replica departures and replacement replica admittance.</span>
<span class="sd">    2. APPLICATION: Restarts the entire application.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">REPLICA</span> <span class="o">=</span> <span class="s2">&quot;REPLICA&quot;</span>
    <span class="n">APPLICATION</span> <span class="o">=</span> <span class="s2">&quot;APPLICATION&quot;</span></div>


<div class="viewcode-block" id="Role"><a class="viewcode-back" href="../../../specs.html#torchx.specs.Role">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Role</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A set of nodes that perform a specific duty within the ``AppDef``.</span>
<span class="sd">    Examples:</span>

<span class="sd">    1. Distributed data parallel app - made up of a single role (trainer).</span>

<span class="sd">    2. App with parameter server - made up of multiple roles (trainer, ps).</span>

<span class="sd">    .. note:: An ``image`` is a software bundle that is installed on the container</span>
<span class="sd">              scheduled by the scheduler. The container on the scheduler dictates</span>
<span class="sd">              what an image actually is. An image could be as simple as a tar-ball</span>
<span class="sd">              or map to a docker image. The scheduler typically knows how to &quot;pull&quot;</span>
<span class="sd">              the image given an image name (str), which could be a simple name</span>
<span class="sd">              (e.g. docker image) or a url e.g. ``s3://path/my_image.tar``).</span>


<span class="sd">    .. note:: An optional ``base_image`` can be specified if the scheduler supports a</span>
<span class="sd">              concept of base images. For schedulers that run Docker containers the</span>
<span class="sd">              base image is not useful since the application image itself can be</span>
<span class="sd">              built from a base image (using the ``FROM base/image:latest`` construct in</span>
<span class="sd">              the Dockerfile). However the base image is useful for schedulers that</span>
<span class="sd">              work with simple image artifacts (e.g. ``*.tar.gz``) that do not have a built-in</span>
<span class="sd">              concept of base images. For these schedulers, specifying a base image that</span>
<span class="sd">              includes dependencies while the main image is the actual application code</span>
<span class="sd">              makes it possible to make changes to the application code without incurring</span>
<span class="sd">              the cost of re-building the uber artifact.</span>

<span class="sd">    Usage:</span>

<span class="sd">    ::</span>

<span class="sd">     trainer = Role(name=&quot;trainer&quot;, &quot;pytorch/torch:1&quot;)</span>
<span class="sd">                 .runs(&quot;my_trainer.py&quot;, &quot;--arg&quot;, &quot;foo&quot;, ENV_VAR=&quot;FOOBAR&quot;)</span>
<span class="sd">                 .replicas(4)</span>
<span class="sd">                 .require(Resource(cpu=1, gpu=1, memMB=500))</span>
<span class="sd">                 .ports({&quot;tcp_store&quot;:8080, &quot;tensorboard&quot;: 8081})</span>


<span class="sd">     # for schedulers that support base_images</span>
<span class="sd">     trainer = Role(name=&quot;trainer&quot;, image=&quot;pytorch/torch:1&quot;, base_image=&quot;common/ml-tools:latest&quot;)...</span>

<span class="sd">    Args:</span>
<span class="sd">            name: name of the role</span>
<span class="sd">            image: a software bundle that is installed on a container.</span>
<span class="sd">            base_image: Optional base image, if schedulers support image overlay</span>
<span class="sd">            entrypoint: command (within the container) to invoke the role</span>
<span class="sd">            args: commandline arguments to the entrypoint cmd</span>
<span class="sd">            env: environment variable mappings</span>
<span class="sd">            replicas: number of container replicas to run</span>
<span class="sd">            max_retries: max number of retries before giving up</span>
<span class="sd">            retry_policy: retry behavior upon replica failures</span>
<span class="sd">            resource: Resource requirement for the role. The role should be scheduled</span>
<span class="sd">                by the scheduler on ``num_replicas`` container, each of them should have at</span>
<span class="sd">                least ``resource`` guarantees.</span>
<span class="sd">            port_map: Port mapping for the role. The key is the unique identifier of the port</span>
<span class="sd">                e.g. &quot;tensorboard&quot;: 9090</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">image</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">base_image</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">entrypoint</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">MISSING</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">env</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">num_replicas</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">max_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">retry_policy</span><span class="p">:</span> <span class="n">RetryPolicy</span> <span class="o">=</span> <span class="n">RetryPolicy</span><span class="o">.</span><span class="n">APPLICATION</span>
    <span class="n">resource</span><span class="p">:</span> <span class="n">Resource</span> <span class="o">=</span> <span class="n">NULL_RESOURCE</span>
    <span class="n">port_map</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">runs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entrypoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Role&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entrypoint</span> <span class="o">=</span> <span class="n">entrypoint</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="o">*</span><span class="n">args</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="o">**</span><span class="n">kwargs</span><span class="p">})</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">replicas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">replicas</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Role&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_replicas</span> <span class="o">=</span> <span class="n">replicas</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">with_retry_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retry_policy</span><span class="p">:</span> <span class="n">RetryPolicy</span><span class="p">,</span> <span class="n">max_retries</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Role&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">retry_policy</span> <span class="o">=</span> <span class="n">retry_policy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span> <span class="o">=</span> <span class="n">max_retries</span>
        <span class="k">return</span> <span class="bp">self</span>

<div class="viewcode-block" id="Role.pre_proc"><a class="viewcode-back" href="../../../specs.html#torchx.specs.Role.pre_proc">[docs]</a>    <span class="k">def</span> <span class="nf">pre_proc</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">scheduler</span><span class="p">:</span> <span class="n">SchedulerBackend</span><span class="p">,</span>
        <span class="c1"># pyre-fixme[24]: AppDryRunInfo was designed to work with Any request object</span>
        <span class="n">dryrun_info</span><span class="p">:</span> <span class="s2">&quot;AppDryRunInfo&quot;</span><span class="p">,</span>
        <span class="c1"># pyre-fixme[24]: AppDryRunInfo was designed to work with Any request object</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;AppDryRunInfo&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Modifies the scheduler request based on the role specific configuration.</span>
<span class="sd">        The method is invoked for each role during scheduler ``submit_dryrun``.</span>
<span class="sd">        If there are multiple roles, the method is invoked for each role in</span>
<span class="sd">        order that is defined by the ``AppDef.roles`` list.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">dryrun_info</span></div></div>


<div class="viewcode-block" id="AppDef"><a class="viewcode-back" href="../../../specs.html#torchx.specs.AppDef">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">AppDef</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a distributed application made up of multiple ``Roles``</span>
<span class="sd">    and metadata. Contains the necessary information for the driver</span>
<span class="sd">    to submit this app to the scheduler.</span>

<span class="sd">    Args:</span>
<span class="sd">        name: Name of application</span>
<span class="sd">        roles: List of roles</span>
<span class="sd">        metadata: AppDef specific configuration, in comparison</span>
<span class="sd">            ``RunConfig`` is runtime specific configuration.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">roles</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Role</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">metadata</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">of</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">roles</span><span class="p">:</span> <span class="n">Role</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;AppDef&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">roles</span> <span class="o">+=</span> <span class="p">[</span><span class="o">*</span><span class="n">roles</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span>

<div class="viewcode-block" id="AppDef.add_metadata"><a class="viewcode-back" href="../../../specs.html#torchx.specs.AppDef.add_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">add_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;AppDef&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds metadata to the application.</span>
<span class="sd">        .. note:: If the key already exists, this method overwrites the metadata value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="bp">self</span></div>

    <span class="k">def</span> <span class="nf">get_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span></div>


<div class="viewcode-block" id="AppState"><a class="viewcode-back" href="../../../specs.html#torchx.specs.AppState">[docs]</a><span class="k">class</span> <span class="nc">AppState</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    State of the application. An application starts from an initial</span>
<span class="sd">    ``UNSUBMITTED`` state and moves through ``SUBMITTED``, ``PENDING``,</span>
<span class="sd">    ``RUNNING`` states finally reaching a terminal state:</span>
<span class="sd">    ``SUCCEEDED``,``FAILED``, ``CANCELLED``.</span>

<span class="sd">    If the scheduler supports preemption, the app moves from a ``RUNNING``</span>
<span class="sd">    state to ``PENDING`` upon preemption.</span>

<span class="sd">    If the user stops the application, then the application state moves</span>
<span class="sd">    to ``STOPPED``, then to ``CANCELLED`` when the job is actually cancelled</span>
<span class="sd">    by the scheduler.</span>

<span class="sd">    1. UNSUBMITTED - app has not been submitted to the scheduler yet</span>
<span class="sd">    2. SUBMITTED - app has been successfully submitted to the scheduler</span>
<span class="sd">    3. PENDING - app has been submitted to the scheduler pending allocation</span>
<span class="sd">    4. RUNNING - app is running</span>
<span class="sd">    5. SUCCEEDED - app has successfully completed</span>
<span class="sd">    6. FAILED - app has unsuccessfully completed</span>
<span class="sd">    7. CANCELLED - app was cancelled before completing</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">UNSUBMITTED</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">SUBMITTED</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">PENDING</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">RUNNING</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">SUCCEEDED</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">FAILED</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">CANCELLED</span> <span class="o">=</span> <span class="mi">6</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span></div>


<span class="n">_TERMINAL_STATES</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">AppState</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">AppState</span><span class="o">.</span><span class="n">SUCCEEDED</span><span class="p">,</span>
    <span class="n">AppState</span><span class="o">.</span><span class="n">FAILED</span><span class="p">,</span>
    <span class="n">AppState</span><span class="o">.</span><span class="n">CANCELLED</span><span class="p">,</span>
<span class="p">]</span>


<span class="k">def</span> <span class="nf">is_terminal</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">AppState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">_TERMINAL_STATES</span>


<span class="c1"># =======================</span>
<span class="c1"># ==== Status API =======</span>
<span class="c1"># =======================</span>

<span class="c1"># replica and app share the same states, simply alias it for now</span>
<span class="n">ReplicaState</span> <span class="o">=</span> <span class="n">AppState</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ReplicaStatus</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The status of the replica during the job execution.</span>

<span class="sd">    Args:</span>
<span class="sd">        id: The node rank, note: this is not a worker rank.</span>
<span class="sd">        state: The current state of the node.</span>
<span class="sd">        role: The role name</span>
<span class="sd">        hostname: The hostname where the replica is running</span>
<span class="sd">        structured_error_msg: Error message if any, None if job succeeded.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">state</span><span class="p">:</span> <span class="n">ReplicaState</span>
    <span class="n">role</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">hostname</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">structured_error_msg</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">NONE</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">RoleStatus</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The status of the role during the job execution.</span>

<span class="sd">    Args:</span>
<span class="sd">        role: Role name</span>
<span class="sd">        replicas: List of replica statuses</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">role</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">replicas</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ReplicaStatus</span><span class="p">]</span>


<div class="viewcode-block" id="AppStatus"><a class="viewcode-back" href="../../../specs.html#torchx.specs.AppStatus">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">AppStatus</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The runtime status of the ``AppDef``. The scheduler can</span>
<span class="sd">    return an arbitrary text message (msg field).</span>
<span class="sd">    If any error occurs, scheduler can populate ``structured_error_msg``</span>
<span class="sd">    with json response.</span>

<span class="sd">    ``replicas`` represent the statuses of the replicas in the job. If the job</span>
<span class="sd">    runs with multiple retries, the parameter will contain the statuses of the</span>
<span class="sd">    most recent retry. Note: if the previous retries failed, but the most recent</span>
<span class="sd">    retry succeeded or in progress, ``replicas`` will not contain occurred errors.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">state</span><span class="p">:</span> <span class="n">AppState</span>
    <span class="n">num_restarts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">msg</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">structured_error_msg</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">NONE</span>
    <span class="n">ui_url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">roles</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">RoleStatus</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_terminal</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">is_terminal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">app_status_dict</span> <span class="o">=</span> <span class="n">asdict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">structured_error_msg</span> <span class="o">=</span> <span class="n">app_status_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;structured_error_msg&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">structured_error_msg</span> <span class="o">!=</span> <span class="n">NONE</span><span class="p">:</span>
            <span class="n">structured_error_msg_parsed</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">structured_error_msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">structured_error_msg_parsed</span> <span class="o">=</span> <span class="n">NONE</span>
        <span class="n">app_status_dict</span><span class="p">[</span><span class="s2">&quot;structured_error_msg&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">structured_error_msg_parsed</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">app_status_dict</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></div>


<span class="c1"># valid ``RunConfig`` values; only support primitives (str, int, float, bool, List[str])</span>
<span class="c1"># TODO(wilsonhong): python 3.9+ supports list[T] in typing, which can be used directly</span>
<span class="c1"># in isinstance(). Should replace with that.</span>
<span class="c1"># see: https://docs.python.org/3/library/stdtypes.html#generic-alias-type</span>
<span class="n">ConfigValue</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span>


<span class="c1"># =======================</span>
<span class="c1"># ==== Run Config =======</span>
<span class="c1"># =======================</span>
<div class="viewcode-block" id="RunConfig"><a class="viewcode-back" href="../../../specs.html#torchx.specs.RunConfig">[docs]</a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">RunConfig</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Additional run configs for the app. These are typically</span>
<span class="sd">    scheduler runtime configs/arguments that do not bind</span>
<span class="sd">    to ``AppDef`` nor the ``Scheduler``. For example</span>
<span class="sd">    a particular cluster (within the scheduler) the application</span>
<span class="sd">    should be submitted to. Since the same app can be launched</span>
<span class="sd">    into multiple types of clusters (dev, prod) the</span>
<span class="sd">    cluster id config does not bind to the app. Neither</span>
<span class="sd">    does this bind to the scheduler since the cluster can</span>
<span class="sd">    be partitioned by size of the instances (S, M, L) or by</span>
<span class="sd">    a preemption setting (e.g. on-demand vs spot).</span>

<span class="sd">    Since ``Session`` allows the application to be submitted</span>
<span class="sd">    to multiple schedulers, users who want to submit the same</span>
<span class="sd">    app into multiple schedulers from the same session can</span>
<span class="sd">    union all the ``RunConfigs`` into a single object. The</span>
<span class="sd">    scheduler implementation will selectively read the configs</span>
<span class="sd">    it needs.</span>

<span class="sd">    This class is intended to be trivially serialized and</span>
<span class="sd">    passed around or saved hence only allow primitives</span>
<span class="sd">    as config values. Should the scheduler need more than</span>
<span class="sd">    simple primitives (e.g. list of str) it is up to the</span>
<span class="sd">    scheduler to document a way to encode this value as a</span>
<span class="sd">    str and parse it (e.g. representing list of str as</span>
<span class="sd">    comma delimited str).</span>

<span class="sd">    Usage:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">     # write</span>
<span class="sd">     config = RunConfig()</span>
<span class="sd">     config.set(&quot;run_as_user&quot;, &quot;prod&quot;)</span>
<span class="sd">     config.set(&quot;priority&quot;, 10)</span>

<span class="sd">     # read</span>
<span class="sd">     config.get(&quot;run_as_user&quot;) # &quot;prod&quot;</span>
<span class="sd">     config.get(&quot;priority&quot;) # 10</span>
<span class="sd">     config.get(&quot;never_set&quot;) # None</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">cfgs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ConfigValue</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cfg_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">cfg_val</span><span class="p">:</span> <span class="n">ConfigValue</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cfgs</span><span class="p">[</span><span class="n">cfg_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">cfg_val</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ConfigValue</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfgs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfgs</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span></div>


<span class="n">T</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">AppDryRunInfo</span><span class="p">(</span><span class="n">Generic</span><span class="p">[</span><span class="n">T</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returned by ``Scheduler.submit_dryrun``. Represents the</span>
<span class="sd">    request that would have been made to the scheduler.</span>
<span class="sd">    The ``fmt_str()`` method of this object should return a</span>
<span class="sd">    pretty formatted string representation of the underlying</span>
<span class="sd">    request object such that ``print(info)`` yields a human</span>
<span class="sd">    readable representation of the underlying request.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">T</span><span class="p">,</span> <span class="n">fmt</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">T</span><span class="p">],</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">request</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fmt</span> <span class="o">=</span> <span class="n">fmt</span>

        <span class="c1"># fields below are only meant to be used by</span>
        <span class="c1"># Scheduler or Session implementations</span>
        <span class="c1"># and are back references to the parameters</span>
        <span class="c1"># to dryrun() that returned this AppDryRunInfo object</span>
        <span class="c1"># thus they are set in Session.dryrun() and Scheduler.submit_dryrun()</span>
        <span class="c1"># manually rather than through constructor arguments</span>
        <span class="c1"># DO NOT create getters or make these public</span>
        <span class="c1"># unless there is a good reason to</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AppDef</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RunConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scheduler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SchedulerBackend</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fmt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_type_name</span><span class="p">(</span><span class="n">tp</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">ConfigValue</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets the type&#39;s name as a string. If ``tp` is a primitive class like int, str, etc, then</span>
<span class="sd">    uses its attribute ``__name__``. Otherwise, use ``str(tp)``.</span>

<span class="sd">    Note: we use this method to print out generic typing like List[str].</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">tp</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span>


<div class="viewcode-block" id="runopts"><a class="viewcode-back" href="../../../specs.html#torchx.specs.runopts">[docs]</a><span class="k">class</span> <span class="nc">runopts</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Holds the accepted scheduler run configuration</span>
<span class="sd">    keys, default value (if any), and help message string.</span>
<span class="sd">    These options are provided by the ``Scheduler`` and validated</span>
<span class="sd">    in ``Session.run`` against user provided ``RunConfig``.</span>
<span class="sd">    Allows ``None`` default values. Required opts must NOT have a</span>
<span class="sd">    non-None default.</span>

<span class="sd">    .. important:: This class has no accessors because it is intended to</span>
<span class="sd">                   be constructed and returned by ``Scheduler.run_config_options``</span>
<span class="sd">                   and printed out as a &quot;help&quot; tool or as part of an exception msg.</span>

<span class="sd">    Usage:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">     opts = runopts()</span>

<span class="sd">     opts.add(&quot;run_as_user&quot;, type_=str, help=&quot;user to run the job as&quot;)</span>
<span class="sd">     opts.add(&quot;cluster_id&quot;, type_=int, help=&quot;cluster to submit the job&quot;, required=True)</span>
<span class="sd">     opts.add(&quot;priority&quot;, type_=float, default=0.5, help=&quot;job priority&quot;)</span>
<span class="sd">     opts.add(&quot;preemptible&quot;, type_=bool, default=False, help=&quot;is the job preemptible&quot;)</span>

<span class="sd">     # invalid</span>
<span class="sd">     opts.add(&quot;illegal&quot;, default=10, required=True)</span>
<span class="sd">     opts.add(&quot;bad_type&quot;, type=str, default=10)</span>

<span class="sd">     opts.check(RunConfig)</span>
<span class="sd">     print(opts)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_opts</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">ConfigValue</span><span class="p">,</span> <span class="n">Type</span><span class="p">[</span><span class="n">ConfigValue</span><span class="p">],</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="runopts.is_type"><a class="viewcode-back" href="../../../specs.html#torchx.specs.runopts.is_type">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">is_type</span><span class="p">(</span><span class="n">obj</span><span class="p">:</span> <span class="n">ConfigValue</span><span class="p">,</span> <span class="n">tp</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">ConfigValue</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns True if ``obj`` is type of ``tp``. Similar to isinstance() but supports</span>
<span class="sd">        tp = List[str], thus can be used to validate ConfigValue.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">tp</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="runopts.add"><a class="viewcode-back" href="../../../specs.html#torchx.specs.runopts.add">[docs]</a>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">cfg_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">type_</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">ConfigValue</span><span class="p">],</span>
        <span class="n">help</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">default</span><span class="p">:</span> <span class="n">ConfigValue</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">required</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds the ``config`` option with the given help string and ``default``</span>
<span class="sd">        value (if any). If the ``default`` is not specified then this option</span>
<span class="sd">        is a required option.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">required</span> <span class="ow">and</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Required option: </span><span class="si">{</span><span class="n">cfg_key</span><span class="si">}</span><span class="s2"> must not specify default value. Given: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">runopts</span><span class="o">.</span><span class="n">is_type</span><span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="n">type_</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Option: </span><span class="si">{</span><span class="n">cfg_key</span><span class="si">}</span><span class="s2">, must be of type: </span><span class="si">{</span><span class="n">type_</span><span class="si">}</span><span class="s2">.&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; Given: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">default</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_opts</span><span class="p">[</span><span class="n">cfg_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="n">required</span><span class="p">,</span> <span class="n">help</span><span class="p">)</span></div>

<div class="viewcode-block" id="runopts.resolve"><a class="viewcode-back" href="../../../specs.html#torchx.specs.runopts.resolve">[docs]</a>    <span class="k">def</span> <span class="nf">resolve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">RunConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RunConfig</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks the given config against this ``runopts`` and sets default configs</span>
<span class="sd">        if not set.</span>

<span class="sd">        .. warning:: This method mutates the provided config!</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># make a copy; don&#39;t need to be deep b/c the values are primitives</span>
        <span class="n">resolved_cfg</span> <span class="o">=</span> <span class="n">RunConfig</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">cfgs</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">cfg_key</span><span class="p">,</span> <span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="n">required</span><span class="p">,</span> <span class="n">_help</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_opts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">resolved_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cfg_key</span><span class="p">)</span>

            <span class="c1"># check required opt</span>
            <span class="k">if</span> <span class="n">required</span> <span class="ow">and</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InvalidRunConfigException</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Required run option: </span><span class="si">{</span><span class="n">cfg_key</span><span class="si">}</span><span class="s2">, must be provided and not None&quot;</span><span class="p">,</span>
                    <span class="n">config</span><span class="p">,</span>
                    <span class="bp">self</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="c1"># check type (None matches all types)</span>
            <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">runopts</span><span class="o">.</span><span class="n">is_type</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">type_</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">InvalidRunConfigException</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Run option: </span><span class="si">{</span><span class="n">cfg_key</span><span class="si">}</span><span class="s2">, must be of type: </span><span class="si">{</span><span class="n">get_type_name</span><span class="p">(</span><span class="n">type_</span><span class="p">)</span><span class="si">}</span><span class="s2">,&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; but was: </span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
                    <span class="n">config</span><span class="p">,</span>
                    <span class="bp">self</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="c1"># not required and not set, set to default</span>
            <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">resolved_cfg</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cfg_key</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">resolved_cfg</span></div>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># make it a pretty printable dict</span>
        <span class="n">pretty_opts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">cfg_key</span><span class="p">,</span> <span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="n">required</span><span class="p">,</span> <span class="n">help</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_opts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;*</span><span class="si">{</span><span class="n">cfg_key</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">required</span> <span class="k">else</span> <span class="n">cfg_key</span>
            <span class="n">opt</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">get_type_name</span><span class="p">(</span><span class="n">type_</span><span class="p">)}</span>
            <span class="k">if</span> <span class="n">required</span><span class="p">:</span>
                <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;required&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;True&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">default</span><span class="p">)</span>
            <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;help&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">help</span>

            <span class="n">pretty_opts</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">opt</span>
        <span class="kn">import</span> <span class="nn">pprint</span>

        <span class="k">return</span> <span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span>
            <span class="n">pretty_opts</span><span class="p">,</span>
            <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">width</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span>
        <span class="p">)</span></div>


<span class="k">class</span> <span class="nc">InvalidRunConfigException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Raised when the supplied ``RunConfig`` does not satisfy the</span>
<span class="sd">    ``runopts``, either due to missing required configs or value</span>
<span class="sd">    type mismatch.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">invalid_reason</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">run_config</span><span class="p">:</span> <span class="n">RunConfig</span><span class="p">,</span> <span class="n">runopts</span><span class="p">:</span> <span class="s2">&quot;runopts&quot;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">invalid_reason</span><span class="si">}</span><span class="s2">. Given: </span><span class="si">{</span><span class="n">run_config</span><span class="si">}</span><span class="s2">, Expected: </span><span class="si">{</span><span class="n">runopts</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">MalformedAppHandleException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Raised when APIs are given a bad app handle.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app_handle</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">app_handle</span><span class="si">}</span><span class="s2"> is not of the form: &lt;scheduler_backend&gt;://&lt;session_name&gt;/&lt;app_id&gt;&quot;</span>
        <span class="p">)</span>


<span class="k">class</span> <span class="nc">UnknownSchedulerException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scheduler_backend</span><span class="p">:</span> <span class="n">SchedulerBackend</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Scheduler backend: </span><span class="si">{</span><span class="n">scheduler_backend</span><span class="si">}</span><span class="s2"> does not exist.&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; Use session.scheduler_backends() to see all supported schedulers&quot;</span>
        <span class="p">)</span>


<span class="c1"># encodes information about a running app in url format</span>
<span class="c1"># {scheduler_backend}://{session_name}/{app_id}</span>
<span class="n">AppHandle</span> <span class="o">=</span> <span class="nb">str</span>


<span class="k">class</span> <span class="nc">UnknownAppException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Raised by ``Session`` APIs when either the application does not</span>
<span class="sd">    exist or the application is not owned by the session.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app_handle</span><span class="p">:</span> <span class="s2">&quot;AppHandle&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Unknown app = </span><span class="si">{</span><span class="n">app_handle</span><span class="si">}</span><span class="s2">. Did you forget to call session.run()?&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; Otherwise, the app may have already finished and purged by the scheduler&quot;</span>
        <span class="p">)</span>


<span class="k">def</span> <span class="nf">make_app_handle</span><span class="p">(</span>
    <span class="n">scheduler_backend</span><span class="p">:</span> <span class="n">SchedulerBackend</span><span class="p">,</span> <span class="n">session_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">app_id</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">scheduler_backend</span><span class="si">}</span><span class="s2">://</span><span class="si">{</span><span class="n">session_name</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">app_id</span><span class="si">}</span><span class="s2">&quot;</span>


<span class="k">def</span> <span class="nf">parse_app_handle</span><span class="p">(</span><span class="n">app_handle</span><span class="p">:</span> <span class="n">AppHandle</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">SchedulerBackend</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    parses the app handle into ```(scheduler_backend, session_name, and app_id)```</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># parse it manually b/c currently torchx does not</span>
    <span class="c1"># define allowed characters nor length for session name and app_id</span>
    <span class="kn">import</span> <span class="nn">re</span>

    <span class="n">pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(?P&lt;scheduler_backend&gt;.+)://(?P&lt;session_name&gt;.+)/(?P&lt;app_id&gt;.+)&quot;</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">app_handle</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">MalformedAppHandleException</span><span class="p">(</span><span class="n">app_handle</span><span class="p">)</span>
    <span class="n">gd</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groupdict</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">gd</span><span class="p">[</span><span class="s2">&quot;scheduler_backend&quot;</span><span class="p">],</span> <span class="n">gd</span><span class="p">[</span><span class="s2">&quot;session_name&quot;</span><span class="p">],</span> <span class="n">gd</span><span class="p">[</span><span class="s2">&quot;app_id&quot;</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">get_argparse_param_type</span><span class="p">(</span><span class="n">parameter</span><span class="p">:</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">object</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">is_primitive</span><span class="p">(</span><span class="n">parameter</span><span class="o">.</span><span class="n">annotation</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">parameter</span><span class="o">.</span><span class="n">annotation</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">str</span>


<span class="k">def</span> <span class="nf">_create_args_parser</span><span class="p">(</span>
    <span class="n">fn_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="p">],</span>
    <span class="n">function_desc</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">args_desc</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">:</span>
    <span class="n">script_parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
        <span class="n">prog</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;torchx run ...torchx_params... </span><span class="si">{</span><span class="n">fn_name</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;App spec: </span><span class="si">{</span><span class="n">function_desc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;help&quot;</span><span class="p">:</span> <span class="n">args_desc</span><span class="p">[</span><span class="n">param_name</span><span class="p">],</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">get_argparse_param_type</span><span class="p">(</span><span class="n">parameter</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">parameter</span><span class="o">.</span><span class="n">default</span> <span class="o">!=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">args</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameter</span><span class="o">.</span><span class="n">default</span>
        <span class="k">if</span> <span class="n">parameter</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">inspect</span><span class="o">.</span><span class="n">_ParameterKind</span><span class="o">.</span><span class="n">VAR_POSITIONAL</span><span class="p">:</span>
            <span class="n">args</span><span class="p">[</span><span class="s2">&quot;nargs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">REMAINDER</span>
            <span class="n">arg_name</span> <span class="o">=</span> <span class="n">param_name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">arg_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;--</span><span class="si">{</span><span class="n">param_name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="s2">&quot;default&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
                <span class="n">args</span><span class="p">[</span><span class="s2">&quot;required&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">script_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="n">arg_name</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">script_parser</span>


<span class="c1"># pyre-ignore[3]: Ignore, and make return List[Any]</span>
<span class="k">def</span> <span class="nf">_get_function_args</span><span class="p">(</span>
    <span class="n">app_fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">AppDef</span><span class="p">],</span> <span class="n">app_args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
    <span class="n">docstring</span> <span class="o">=</span> <span class="n">none_throws</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getdoc</span><span class="p">(</span><span class="n">app_fn</span><span class="p">))</span>
    <span class="n">function_desc</span><span class="p">,</span> <span class="n">args_desc</span> <span class="o">=</span> <span class="n">parse_fn_docstring</span><span class="p">(</span><span class="n">docstring</span><span class="p">)</span>

    <span class="n">parameters</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">app_fn</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span>
    <span class="n">script_parser</span> <span class="o">=</span> <span class="n">_create_args_parser</span><span class="p">(</span>
        <span class="n">app_fn</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">function_desc</span><span class="p">,</span> <span class="n">args_desc</span>
    <span class="p">)</span>

    <span class="n">parsed_args</span> <span class="o">=</span> <span class="n">script_parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">app_args</span><span class="p">)</span>

    <span class="n">function_args</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">var_arg</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">arg_value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">parsed_args</span><span class="p">,</span> <span class="n">param_name</span><span class="p">)</span>
        <span class="n">parameter_type</span> <span class="o">=</span> <span class="n">parameter</span><span class="o">.</span><span class="n">annotation</span>
        <span class="n">parameter_type</span> <span class="o">=</span> <span class="n">decode_optional</span><span class="p">(</span><span class="n">parameter_type</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_primitive</span><span class="p">(</span><span class="n">parameter_type</span><span class="p">):</span>
            <span class="n">arg_value</span> <span class="o">=</span> <span class="n">decode_from_string</span><span class="p">(</span><span class="n">arg_value</span><span class="p">,</span> <span class="n">parameter_type</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parameter</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">inspect</span><span class="o">.</span><span class="n">_ParameterKind</span><span class="o">.</span><span class="n">VAR_POSITIONAL</span><span class="p">:</span>
            <span class="n">var_arg</span> <span class="o">=</span> <span class="n">arg_value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">function_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg_value</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">var_arg</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">var_arg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;--&quot;</span><span class="p">:</span>
        <span class="n">var_arg</span> <span class="o">=</span> <span class="n">var_arg</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">return</span> <span class="n">function_args</span><span class="p">,</span> <span class="n">var_arg</span>


<span class="k">def</span> <span class="nf">_validate_and_raise</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">function_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">file_content</span> <span class="o">=</span> <span class="n">read_conf_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
    <span class="n">linter_errors</span> <span class="o">=</span> <span class="n">validate</span><span class="p">(</span><span class="n">file_content</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">function_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">linter_errors</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">linter_error</span><span class="o">.</span><span class="n">description</span> <span class="k">for</span> <span class="n">linter_error</span> <span class="ow">in</span> <span class="n">linter_errors</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Encountered linter errors while processing </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">function_name</span><span class="si">}</span><span class="s2">: </span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">error_msg</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>


<span class="k">def</span> <span class="nf">from_function</span><span class="p">(</span>
    <span class="n">app_fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">AppDef</span><span class="p">],</span>
    <span class="n">app_args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">should_validate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AppDef</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">should_validate</span><span class="p">:</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getfile</span><span class="p">(</span><span class="n">app_fn</span><span class="p">)</span>
        <span class="n">_validate_and_raise</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">app_fn</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">function_args</span><span class="p">,</span> <span class="n">var_arg</span> <span class="o">=</span> <span class="n">_get_function_args</span><span class="p">(</span><span class="n">app_fn</span><span class="p">,</span> <span class="n">app_args</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">app_fn</span><span class="p">(</span><span class="o">*</span><span class="n">function_args</span><span class="p">,</span> <span class="o">*</span><span class="n">var_arg</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">from_file</span><span class="p">(</span>
    <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">function_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">app_args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">should_validate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AppDef</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates an application by extracting user defined ``function_name`` and running it.</span>

<span class="sd">    ``function_name`` has the following restrictions:</span>
<span class="sd">        * Name must be ``function_name``</span>
<span class="sd">        * All arguments should be annotated</span>
<span class="sd">        * Supported argument types:</span>
<span class="sd">            - primitive: int, str, float</span>
<span class="sd">            - Dict[primitive, primitive]</span>
<span class="sd">            - List[primitive]</span>
<span class="sd">            - Optional[Dict[primitive, primitive]]</span>
<span class="sd">            - Optional[List[primitive]]</span>
<span class="sd">        * ``function_name`` can define a vararg (*arg) at the end</span>
<span class="sd">        * There should be a docstring for the function that defines</span>
<span class="sd">            All arguments in a google-style format</span>
<span class="sd">        * There can be default values for the function arguments.</span>
<span class="sd">        * The return object must be ``AppDef``</span>

<span class="sd">    Args:</span>
<span class="sd">        file_path: The path to the torchx file, mainly used for validation info.</span>
<span class="sd">        function_name: Function name</span>
<span class="sd">        app_args: Application arguments that will be decoded based on the</span>
<span class="sd">            ``function_name`` arguments types and passed to ``function_name``</span>

<span class="sd">    Returns:</span>
<span class="sd">        An application spec</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">should_validate</span><span class="p">:</span>
        <span class="n">_validate_and_raise</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">function_name</span><span class="p">)</span>

    <span class="n">file_content</span> <span class="o">=</span> <span class="n">read_conf_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

    <span class="n">namespace</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()</span>
    <span class="n">exec</span><span class="p">(</span><span class="n">file_content</span><span class="p">,</span> <span class="n">namespace</span><span class="p">)</span>  <span class="c1"># noqa: P204</span>
    <span class="k">if</span> <span class="n">function_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">namespace</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Function </span><span class="si">{</span><span class="n">function_name</span><span class="si">}</span><span class="s2"> does not exist in file </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">app_fn</span> <span class="o">=</span> <span class="n">namespace</span><span class="p">[</span><span class="n">function_name</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">from_function</span><span class="p">(</span><span class="n">app_fn</span><span class="p">,</span> <span class="n">app_args</span><span class="p">,</span> <span class="n">should_validate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">from_module</span><span class="p">(</span>
    <span class="n">module</span><span class="p">:</span> <span class="n">ModuleType</span><span class="p">,</span>
    <span class="n">function_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">app_args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">should_validate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AppDef</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates an application by extracting user defined ``function_name`` and running it.</span>

<span class="sd">    ``function_name`` has the following restrictions:</span>
<span class="sd">        * Name must be ``function_name``</span>
<span class="sd">        * All arguments should be annotated</span>
<span class="sd">        * Supported argument types:</span>
<span class="sd">            - primitive: int, str, float</span>
<span class="sd">            - Dict[primitive, primitive]</span>
<span class="sd">            - List[primitive]</span>
<span class="sd">            - Optional[Dict[primitive, primitive]]</span>
<span class="sd">            - Optional[List[primitive]]</span>
<span class="sd">        * ``function_name`` can define a vararg (*arg) at the end</span>
<span class="sd">        * There should be a docstring for the function that defines</span>
<span class="sd">            All arguments in a google-style format</span>
<span class="sd">        * There can be default values for the function arguments.</span>
<span class="sd">        * The return object must be ``AppDef``</span>

<span class="sd">    Args:</span>
<span class="sd">        file_path: The path to the torchx file, mainly used for validation info.</span>
<span class="sd">        function_name: Function name</span>
<span class="sd">        app_args: Application arguments that will be decoded based on the</span>
<span class="sd">            ``function_name`` arguments types and passed to ``function_name``</span>

<span class="sd">    Returns:</span>
<span class="sd">        An application spec</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">function_name</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Module </span><span class="si">{</span><span class="n">module</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> has no function: </span><span class="si">{</span><span class="n">function_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">app_fn</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">function_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">from_function</span><span class="p">(</span><span class="n">app_fn</span><span class="p">,</span> <span class="n">app_args</span><span class="p">,</span> <span class="n">should_validate</span><span class="o">=</span><span class="n">should_validate</span><span class="p">)</span>
</pre></div>

     </article>
     
    </div>
    <footer>
  

  

    <hr>

  

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, TorchX Contributors.

    </p>
  </div>
    
      <div>
        Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
      </div>
     

</footer>

  </div>
        </div>

        <div class="pytorch-content-right" id="pytorch-content-right">
          <div class="pytorch-right-menu" id="pytorch-right-menu">
            <div class="pytorch-side-scroll" id="pytorch-side-scroll-right">
              
            </div>
          </div>
        </div>
      </section>
    </div>

  


  

     
       <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
         <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
         <script src="../../../_static/jquery.js"></script>
         <script src="../../../_static/underscore.js"></script>
         <script src="../../../_static/doctools.js"></script>
         <script src="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.js"></script>
         <script src="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/contrib/auto-render.min.js"></script>
         <script src="../../../_static/katex_autorenderer.js"></script>
         <script src="../../../_static/js/torchx.js"></script>
     

  

  <script type="text/javascript" src="../../../_static/js/vendor/popper.min.js"></script>
  <script type="text/javascript" src="../../../_static/js/vendor/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>
  <script type="text/javascript" src="../../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

  <!-- Begin Footer -->

  <div class="container-fluid docs-tutorials-resources" id="docs-tutorials-resources">
    <div class="container">
      <div class="row">
        <div class="col-md-4 text-center">
          <h2>Docs</h2>
          <p>Access comprehensive developer documentation for PyTorch</p>
          <a class="with-right-arrow" href="https://pytorch.org/docs/stable/index.html">View Docs</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Tutorials</h2>
          <p>Get in-depth tutorials for beginners and advanced developers</p>
          <a class="with-right-arrow" href="https://pytorch.org/tutorials">View Tutorials</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Resources</h2>
          <p>Find development resources and get your questions answered</p>
          <a class="with-right-arrow" href="https://pytorch.org/resources">View Resources</a>
        </div>
      </div>
    </div>
  </div>

  <footer class="site-footer">
    <div class="container footer-container">
      <div class="footer-logo-wrapper">
        <a href="https://pytorch.org/" class="footer-logo"></a>
      </div>

      <div class="footer-links-wrapper">
        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.org/">PyTorch</a></li>
            <li><a href="https://pytorch.org/get-started">Get Started</a></li>
            <li><a href="https://pytorch.org/features">Features</a></li>
            <li><a href="https://pytorch.org/ecosystem">Ecosystem</a></li>
            <li><a href="https://pytorch.org/blog/">Blog</a></li>
            <li><a href="https://github.com/pytorch/pytorch/blob/master/CONTRIBUTING.md">Contributing</a></li>
          </ul>
        </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.org/resources">Resources</a></li>
            <li><a href="https://pytorch.org/tutorials">Tutorials</a></li>
            <li><a href="https://pytorch.org/docs/stable/index.html">Docs</a></li>
            <li><a href="https://discuss.pytorch.org" target="_blank">Discuss</a></li>
            <li><a href="https://github.com/pytorch/pytorch/issues" target="_blank">Github Issues</a></li>
            <li><a href="https://pytorch.org/assets/brand-guidelines/PyTorch-Brand-Guidelines.pdf" target="_blank">Brand Guidelines</a></li>
          </ul>
        </div>

        <div class="footer-links-col follow-us-col">
          <ul>
            <li class="list-title">Stay Connected</li>
            <li>
              <div id="mc_embed_signup">
                <form
                  action="https://twitter.us14.list-manage.com/subscribe/post?u=75419c71fe0a935e53dfa4a3f&id=91d0dccd39"
                  method="post"
                  id="mc-embedded-subscribe-form"
                  name="mc-embedded-subscribe-form"
                  class="email-subscribe-form validate"
                  target="_blank"
                  novalidate>
                  <div id="mc_embed_signup_scroll" class="email-subscribe-form-fields-wrapper">
                    <div class="mc-field-group">
                      <label for="mce-EMAIL" style="display:none;">Email Address</label>
                      <input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL" placeholder="Email Address">
                    </div>

                    <div id="mce-responses" class="clear">
                      <div class="response" id="mce-error-response" style="display:none"></div>
                      <div class="response" id="mce-success-response" style="display:none"></div>
                    </div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->

                    <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_75419c71fe0a935e53dfa4a3f_91d0dccd39" tabindex="-1" value=""></div>

                    <div class="clear">
                      <input type="submit" value="" name="subscribe" id="mc-embedded-subscribe" class="button email-subscribe-button">
                    </div>
                  </div>
                </form>
              </div>

            </li>
          </ul>

          <div class="footer-social-icons">
            <a href="https://www.facebook.com/pytorch" target="_blank" class="facebook"></a>
            <a href="https://twitter.com/pytorch" target="_blank" class="twitter"></a>
            <a href="https://www.youtube.com/pytorch" target="_blank" class="youtube"></a>
          </div>
        </div>
      </div>
    </div>
  </footer>

  <div class="cookie-banner-wrapper">
  <div class="container">
    <p class="gdpr-notice">To analyze traffic and optimize your experience, we serve cookies on this site. By clicking or navigating, you agree to allow our usage of cookies. As the current maintainers of this site, Facebookâ€™s Cookies Policy applies. Learn more, including about available controls: <a href="https://www.facebook.com/policies/cookies/">Cookies Policy</a>.</p>
    <img class="close-button" src="../../../_static/images/pytorch-x.svg">
  </div>
</div>

  <!-- End Footer -->

  <!-- Begin Mobile Menu -->

  <div class="mobile-main-menu">
    <div class="container-fluid">
      <div class="container">
        <div class="mobile-main-menu-header-container">
          <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>
          <a class="main-menu-close-button" href="#" data-behavior="close-mobile-menu"></a>
        </div>
      </div>
    </div>

    <div class="mobile-main-menu-links-container">
      <div class="main-menu">
        <ul>
          <li>
            <a href="https://pytorch.org/get-started">Get Started</a>
          </li>

          <li>
            <a href="https://pytorch.org/ecosystem">Ecosystem</a>
          </li>

          <li>
            <a href="https://pytorch.org/mobile">Mobile</a>
          </li>

          <li>
            <a href="https://pytorch.org/hub">PyTorch Hub</a>
          </li>

          <li>
            <a href="https://pytorch.org/blog/">Blog</a>
          </li>

          <li>
            <a href="https://pytorch.org/tutorials">Tutorials</a>
          </li>

          <li class="resources-mobile-menu-title">
            Docs
          </li>

          <ul class="resources-mobile-menu-items">
            <li>
              <a href="https://pytorch.org/docs/stable/index.html">PyTorch</a>
            </li>

            <li>
              <a href="https://pytorch.org/audio/stable/index.html">torchaudio</a>
            </li>

            <li>
              <a href="https://pytorch.org/text/stable/index.html">torchtext</a>
            </li>

            <li>
              <a href="https://pytorch.org/vision/stable/index.html">torchvision</a>
            </li>

            <li>
              <a href="https://pytorch.org/elastic/">TorchElastic</a>
            </li>

            <li>
              <a href="https://pytorch.org/serve/">TorchServe</a>
            </li>

            <li>
              <a href="https://pytorch.org/xla">PyTorch on XLA Devices</a>
            </li>
          </ul>

          <li class="resources-mobile-menu-title">
            Resources
          </li>

          <ul class="resources-mobile-menu-items">
            <li>
              <a href="https://pytorch.org/resources">Developer Resources</a>
            </li>

            <li>
              <a href="https://pytorch.org/features">About</a>
            </li>

            <li>
              <a href="https://pytorch.org/hub">Models (Beta)</a>
            </li>

            <li>
              <a href="https://pytorch.org/#community-module">Community</a>
            </li>

            <li>
              <a href="https://discuss.pytorch.org/">Forums</a>
            </li>
          </ul>

          <li>
            <a href="https://github.com/pytorch/pytorch">Github</a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- End Mobile Menu -->

  <script type="text/javascript" src="../../../_static/js/vendor/anchor.min.js"></script>

  <script type="text/javascript">
    $(document).ready(function() {
      mobileMenu.bind();
      mobileTOC.bind();
      pytorchAnchors.bind();
      sideMenus.bind();
      scrollToAnchor.bind();
      highlightNavigation.bind();
      mainMenuDropdown.bind();
      filterTags.bind();

      // Add class to links that have code blocks, since we cannot create links in code blocks
      $("article.pytorch-article a span.pre").each(function(e) {
        $(this).closest("a").addClass("has-code");
      });
    })
  </script>
</body>
</html>